<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kraken to TAK</title>
    <style>
        body {
            background-color: black;
            color: yellow;
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        h1 {
            font-size: 40px;
        }

        h2 {
            font-size: 20px;
        }

        label {
            display: block;
            margin-top: 10px;
        }

        input {
            padding: 5px;
            margin-top: 5px;
            width: 10%;
        }

        button {
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        #persistDOALineButton {
            font-size: 18px;
            width: 200px;
        }

        #persistDOALineButton.true-state {
            background-color: green;
            color: white;
        }

        #persistDOALineButton.false-state {
            background-color: red;
            color: white;
        }

        #saveKrakenServerButton {
            background-color: #4CAF50;
            color: white;
        }

        #saveTAKServerButton {
            background-color: #4CAF50;
            color: white;
        }

        #takMulticast {
            font-size: 18px;
            width: 200px;
        }

        #takMulticast.true-state {
            background-color: green;
            color: white;
        }

        #takMulticast.false-state {
            background-color: red;
            color: white;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize toggle state
            var persistDOALineToggle = false;
            var uid_line = 'DOA-to-TAK';

            // Function to toggle the persist DOA Line state
            function togglePersistDOALine() {
                var button = document.getElementById("persistDOALineButton");
                var uidLineSuffix = parseInt(uid_line.split('-')[1] || 0) + 1;
                var updatedUid_line = 'DOA-to-TAK-' + uidLineSuffix;

                // Make an AJAX request to update the uid_line variable
                updateServerSettings(!persistDOALineToggle, updatedUid_line, function () {
                    if (!persistDOALineToggle) {
                        // Update button style for true state (green)
                        button.classList.add("true-state");
                        button.classList.remove("false-state");
                        button.innerHTML = "Persisting DOA Lines";
                    } else {
                        // Update button style for false state (red)
                        button.classList.add("false-state");
                        button.classList.remove("true-state");
                        button.innerHTML = "Persist DOA Line";
                    }

                    // Alert outside the if-else block
                    alert("Persist DOA Line set to: " + !persistDOALineToggle + " with UID: " + updatedUid_line);
                });
            }

            // Function to make an AJAX request to update the server settings
            function updateServerSettings(persistDOALineToggle, uid_line, callback) {
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/update_settings", true);
                xhr.setRequestHeader("Content-Type", "application/json");

                // Create JSON object with updated settings
                var settings = {
                    persist_doa_line: persistDOALineToggle,
                    uid_line: uid_line
                };

                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        console.log("Settings updated successfully");
                        callback();
                    }
                };

                // Send the JSON object as the request payload
                xhr.send(JSON.stringify(settings));
            }

            // Event listener for Toggle Persist DOA Line button
            document.getElementById("persistDOALineButton").addEventListener("click", togglePersistDOALine);

            // TAK Multicast On/Off
            document.addEventListener('DOMContentLoaded', function () {
                // Initialize toggle state
                var takMulticastToggleState = true;

                // Function to toggle TAK Multicast
                function toggleTAKMulticast() {
                    var button = document.getElementById("takMulticastToggle");

                    // Make an AJAX request to update the mesh_mode variable
                    updateServerSettings(!takMulticastToggleState, mesh_mode, function () {
                        if (!takMulticastToggleState) {
                            // Update button style for true state (green)
                            button.classList.add("true-state");
                            button.classList.remove("false-state");
                            button.innerHTML = "Broadcasting to 239.2.3.1:6969";
                        } else {
                            // Update button style for false state (red)
                            button.classList.add("false-state");
                            button.classList.remove("true-state");
                            button.innerHTML = "Not sending multicast";
                        }

                        // Alert outside the if-else block
                        alert("Enable TAK Multicast set to: " + !takMulticastToggleState + " in state: " + mesh_mode);
                    });
                }

                // Function to make an AJAX request to update the server settings
                function updateServerSettings(takMulticastToggleState, mesh_mode, callback) {
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "/update_settings", true);
                    xhr.setRequestHeader("Content-Type", "application/json");

                    // Create JSON object with updated settings
                    var settings = {
                        mesh_mode: takMulticastToggleState,
                    };

                    xhr.onreadystatechange = function () {
                        if (xhr.readyState == 4 && xhr.status == 200) {
                            console.log("Settings updated successfully");
                            callback();
                        }
                    };

                    // Send the JSON object as the request payload
                    xhr.send(JSON.stringify(settings));
                }

                // Event listener for TAK Multicast button
                document.getElementById("takMulticast").addEventListener("click", toggleTAKMulticast);
            });

            // Event listener for Save Kraken Server button
            document.getElementById("saveKrakenServerButton").addEventListener("click", function () {
                var newKrakenServer = document.getElementById("krakenServerInput").value;
                if (newKrakenServer.trim() !== "") {  // Trim to handle potential extra whitespaces
                    // Ensure correct route, method, and JSON format for your specific server-side implementation
                    fetch('/update_settings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ kraken_server: newKrakenServer })
                    })
                        .then(response => response.text())
                        .then(data => {
                            alert(data);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                    alert("Kraken Server updated successfully!");
                } else {
                    alert("Please enter a valid Kraken Server address.");
                }
            });

            var saveTakStuff = function () {
                var newTAKServerIP = document.getElementById("takServerIpInput").value;
                var newTAKServerPort = document.getElementById("takServerPortInput").value;

                // Check if both TAK Server IP and Port are provided and are valid integers
                if (newTAKServerIP.trim() !== "" && /^\d+$/.test(newTAKServerPort.trim())) {

                    // Send data as JSON to the server for updating settings
                    fetch('/update_settings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ tak_server_ip: newTAKServerIP, tak_server_port: newTAKServerPort })
                    })
                        .then(response => response.text())
                        .then(data => {
                            // Display the response from the server in an alert
                            alert(data);
                        })
                        .catch(error => {
                            // Log any errors that occur during the fetch request
                            console.error('Error:', error);
                        });

                    // Display a success message to the user
                    alert("TAK Server IP and Port updated successfully!");
                } else {
                    // Display an alert if either TAK Server IP or Port is missing or invalid
                    alert("Please enter both a valid TAK Server IP and Port before saving.");
                }
            }

            // Event listener for Save TAK Server IP and Port button
            document.getElementById("saveTAKServerButton").addEventListener("click", saveTakStuff);
        });
    </script>
</head>

<body>
    <h1>Kraken to TAK</h1>
    <label for="krakenServerInput">Kraken Server IPv4:</label>
    <input type="text" id="krakenServerInput" placeholder="Default 0.0.0.0">
    <button id="saveKrakenServerButton">Save</button>

    <label for="takServerIpInput">TAK Destination IPv4:</label>
    <input type="text" id="takServerIpInput" placeholder="Default 239.2.3.1">

    <label for="takServerPortInput">TAK Destination Port:</label>
    <input type="text" id="takServerPortInput" placeholder="Default 6969">

    <button id="saveTAKServerButton">Save</button>

    <label for="takMulticast">On/Off multicast to 239.2.3.1:6969</label>
    <button id="takMulticast" class="true-state">Broadcasting</button>

    <div>
        <h2>DOA Ignore/ Exclusion Range</h2>
        <form id="doaIgnoreForm">
            <label for="startAngle">Start DOA Bearing:</label>
            <input type="number" id="startAngle" min="0" max="359" required placeholder="A number 0-359">

            <label for="endAngle">End DOA Bearing:</label>
            <input type="number" id="endAngle" min="0" max="359" required placeholder="Moving clockwise 0-359">

            <button type="button" onclick="saveDOAIgnoreRange()">Save</button>
        </form>
    </div>
    <label for="persistDOALineButton">New line instead of a single line? Push this.</label>
    <button id="persistDOALineButton" class="false-state">Persist DOA Line</button>

</body>

</html>